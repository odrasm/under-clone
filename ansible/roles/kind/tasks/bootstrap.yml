---
- name: Get latest KinD release
  uri:
    url: https://api.github.com/repos/kubernetes-sigs/kind/releases/latest
    return_content: yes
  register: kind_release
  when: kind_version is not defined 

- name: Get latest kubectl release
  uri:
    url: https://dl.k8s.io/release/stable.txt
    return_content: yes
  register: kubectl_release
  when: kubectl_version is not defined 

- name: Set KinD version
  set_fact:
    kind_version: "{{ kind_release.json.tag_name }}"
  when: kind_version is not defined

- name: Set kubectl version
  set_fact:
    kubectl_version: "{{ kubectl_release.json.tag_name }}"
  when: kubectl_version is not defined

- name: Create KinD Home Dir
  file:
    state: directory
    name: "{{ item }}"
  loop:
    - "{{ kind_home_dir }}"
    - "{{ kind_home_dir }}/{{ cluster_name }}"

- name: Install python library
  pip:
    name:
      - openshift
      - kubernetes

- name: Check if KinD is installed
  command:
    argv:
      - kind
      - version
  register: kind_result
  ignore_errors: True
  changed_when: False

- name: Check if kubectl is installed
  command:
    argv:
      - kubectl
      - version
      - --client=true
      - --short=true
  register: kubectl_result
  ignore_errors: True
  changed_when: False

- name: Set KinD Linux download binary
  set_fact:
      kind_download_binary: "https://github.com/kubernetes-sigs/kind/releases/download/{{ kind_version }}/kind-linux-amd64"
  when: kind_result.rc != 0 and (ansible_os_family == "RedHat" or ansible_os_family == "CentOS" or ansible_os_family == "Debian")

- name: Set kubectl Linux download binary
  set_fact:
      kubectl_download_binary: "https://dl.k8s.io/release/{{ kubectl_version }}/bin/linux/amd64/kubectl"
  when: kubectl_result.rc != 0 and (ansible_os_family == "RedHat" or ansible_os_family == "CentOS" or ansible_os_family == "Debian")

- name: Create user local bin directory
  file:
    path: /usr/local/bin
    state: directory
  become: yes
  become_user: root
  when: kind_result.rc != 0

- name: Download KinD binary
  get_url:
    url: "{{ kind_download_binary }}"
    dest: "/usr/local/bin/kind"
    mode: "0755"
  become: yes
  when: kind_result.rc != 0
  register: downloaded_kind

- name: Download kubectl binary
  get_url:
    url: "{{ kubectl_download_binary }}"
    dest: "/usr/local/bin/kubectl"
    mode: "0755"
  become: yes
  when: kubectl_result.rc != 0
  register: downloaded_kubectl

- name: set kind binary fact
  set_fact:
    kind_binary: /usr/local/bin/kind

- name: set kubectl binary fact
  set_fact:
    kubectl_binary: /usr/local/bin/kubectl

- name: pull kindest nodet image
  docker_image:
    name: "{{ kind_node_image }}" 
    source: pull

